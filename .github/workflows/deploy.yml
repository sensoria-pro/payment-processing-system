# Triggers: run on push to the main branch and on Pull Request in main
name: Main CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # --- JOB 1: Build and Test ---
  # This job is the core job. It tests the code and builds Docker images.
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code # 1. Download the source code of the repository
        uses: actions/checkout@v5

      - name: Set up Go # 2. Setting up the Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run Linter (golangci-lint) # 3. Run the linter (code style check)
        uses: golangci/golangci-lint-action@v8


      - name: Run Tests # 4. Run tests
        run: go test -race -coverprofile=coverage.txt -covermode=atomic ./...


      - name: Login to Docker Hub # 5. Login to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. Build and publish the payment-gateway image
      - name: Build and push payment-gateway
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }} # push=true only for main
          tags: tonygilman/payment-processing-system:latest

      # 7. Build and publish the anti-fraud-analyzer image
      - name: Build and push anti-fraud-analyzer
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.antifraud
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: tonygilman/anti-fraud-analyzer:latest
  

  # --- JOB 2: Security Scan ---
  # This job runs in parallel with build-and-test to save time.
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Dependency Review  # 1. Check dependencies at all
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4

      - name: Build image for scan # 2. Scanning Docker images for vulnerabilities
        run: docker build -t temp-gateway-image -f ./Dockerfile .

      - name: Scan image with Trivy # 3. Scanning Docker images for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'temp-gateway-image'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'

  # --- JOB 3: Deploy ---
  # This job is only run after 'build-and-test' has completed successfully
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]  # Wait for build-and-test and security-scan to complete
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.2.2 # 1. Deploy to Production Server
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USERNAME }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd /opt/app
            
            # Create a .env file with secrets BEFORE launching
            echo "${{ secrets.PROD_ENV_FILE }}" > .env
            # Login to Docker Hub to download fresh images
            echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            
            # Download the latest versions of the images that we just published
            docker-compose pull

            # Restart services. Docker Compose will recreate only those containers whose images have been updated.
            docker-compose up -d