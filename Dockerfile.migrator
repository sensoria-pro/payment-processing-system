# Dockerfile.migrator
FROM clickhouse/clickhouse-server:24.3

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ bash (Ð² alpine Ð¾Ð½ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ)
RUN apk add --no-cache bash

# Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
COPY migrations_clickhouse /migrations/

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚
CMD ["bash", "-c", "
echo 'ðŸŸ¡ Waiting for ClickHouse...'
while ! clickhouse-client --host clickhouse --port 9000 --query='SELECT 1' 2>/dev/null; do
  sleep 3
done
echo 'âœ… ClickHouse is ready. Applying migration...'

clickhouse-client --host clickhouse --port 9000 < /migrations/000001_create_fraud_reports.up.sql

echo 'ðŸŽ‰ Migration completed.'
"]