FROM clickhouse/clickhouse-server:24.3

# –£—Å—Ç–∞–Ω–æ–≤–∏ bash —á–µ—Ä–µ–∑ apt (–æ–±—Ä–∞–∑ –Ω–∞ Ubuntu/Debian, –Ω–µ Alpine!)
RUN apt-get update && \
    apt-get install -y --no-install-recommends bash && \
    rm -rf /var/lib/apt/lists/*

# –°–∫–æ–ø–∏—Ä—É–π –º–∏–≥—Ä–∞—Ü–∏–∏
COPY migrations_clickhouse /migrations/

# –ó–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç
CMD ["bash", "-c", "echo 'üü° Waiting for ClickHouse...' && \
while ! clickhouse-client --host clickhouse --port 9000 --query='SELECT 1' >/dev/null 2>&1; do \
  echo '‚è≥ ClickHouse is not ready yet, waiting...'; \
  sleep 3; \
done && \
echo '‚úÖ ClickHouse is ready. Applying migration...' && \
clickhouse-client --host clickhouse --port 9000 < /migrations/init.sql && \
echo 'üéâ Migration completed.'"]